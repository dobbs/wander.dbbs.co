{
  "version": 3,
  "mappings": "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",
  "names": [
    "expand",
    "text",
    "replace",
    "ignore",
    "e",
    "preventDefault",
    "stopPropagation",
    "context",
    "$item",
    "sites",
    "location",
    "host",
    "remote",
    "parents",
    "data",
    "push",
    "journal",
    "ref",
    "action",
    "includes",
    "site",
    "post_upload",
    "item",
    "form",
    "$progress",
    "find",
    "tick",
    "lengthComputable",
    "percentComplete",
    "loaded",
    "total",
    "parseInt",
    "width",
    "$",
    "ajax",
    "url",
    "type",
    "processData",
    "contentType",
    "success",
    "empty",
    "emit",
    "bind",
    "error",
    "console",
    "log",
    "statusText",
    "responseText",
    "xhr",
    "XMLHttpRequest",
    "upload",
    "addEventListener",
    "get_file",
    "assets",
    "match",
    "filename",
    "split",
    "reverse",
    "fetch",
    "then",
    "response",
    "blob",
    "file",
    "File",
    "FormData",
    "append",
    "name",
    "message",
    "delete_file",
    "fetch_list",
    "$report",
    "assetsData",
    "requestSite",
    "assetsURL",
    "wiki",
    "getDirectURL",
    "link",
    "href",
    "encodeURIComponent",
    "act",
    "isOwner",
    "render",
    "code",
    "files",
    "length",
    "html",
    "results",
    "join",
    "click",
    "target",
    "parent",
    "attr",
    "trouble",
    "getURL",
    "dataType",
    "uploader",
    "hasClass",
    "addClass",
    "get",
    "prepend",
    "flag",
    "dblclick",
    "textEditor",
    "$button",
    "$input",
    "on",
    "window",
    "plugins",
    "module",
    "exports"
  ],
  "sourceRoot": "",
  "sources": [
    "assets.coffee"
  ],
  "sourcesContent": [
    "\nexpand = (text)->\n  text\n    .replace /&/g, '&amp;'\n    .replace /</g, '&lt;'\n    .replace />/g, '&gt;'\n\nignore = (e) ->\n  e.preventDefault()\n  e.stopPropagation()\n\ncontext = ($item) ->\n  sites = [location.host]\n  if remote = $item.parents('.page').data('site')\n    unless remote == location.host\n      sites.push remote\n  journal = $item.parents('.page').data('data').journal\n  for action in journal.slice(0).reverse()\n    if action.site? and not sites.includes(action.site)\n      sites.push action.site\n  sites\n\npost_upload = ($item, item, form) ->\n  $progress = $item.find '.progress-bar'\n\n  tick = (e) ->\n    return unless e.lengthComputable\n    percentComplete = e.loaded / e.total\n    percentComplete = parseInt(percentComplete * 100)\n    $progress.text \"#{percentComplete}%\"\n    $progress.width \"#{percentComplete}%\"\n\n  $.ajax\n    url: '/plugin/assets/upload'\n    type: 'POST'\n    data: form\n    processData: false\n    contentType: false\n    success: ->\n      $item.empty()\n      emit $item, item\n      bind $item, item\n    error: (e) ->\n      console.log 'error', e\n      $progress.text \"upload error: #{e.statusText} #{e.responseText||''}\"\n      $progress.width '100%'\n    xhr: ->\n      xhr = new XMLHttpRequest\n      xhr.upload.addEventListener 'progress', tick, false\n      xhr\n\nget_file = ($item, item, url, success) ->\n  assets = item.text.match(/([\\w\\/-]*)/)[1]\n  filename = url.split('/').reverse()[0]\n  fetch(url).then((response) ->\n    response.blob()\n  ).then((blob) ->\n    file = new File(\n      [blob],\n      filename,\n      { type: blob.type }\n    )\n\n    form = new FormData()\n    form.append 'assets', assets\n    form.append 'uploads[]', file, file.name\n    success form\n  ).catch((e) ->\n    $progress = $item.find '.progress-bar'\n    $progress.text \"Copy error: #{e.message}\"\n    $progress.width '100%'\n  )\n\n\ndelete_file = ($item, item, url) ->\n  file = url.split('/').reverse()[0]\n  assets = item.text\n  $.ajax\n    url: \"/plugin/assets/delete?file=#{file}&assets=#{assets}\"\n    type: 'POST'\n    success: () ->\n      $item.empty()\n      emit $item, item\n      bind $item, item\n    error: (e) ->\n      $progress = $item.find '.progress-bar'\n      $progress.text \"Delete error: #{e.statusText} #{e.responseText||''}\"\n      $progress.width '100%'\n\nfetch_list = ($item, item, $report, assets, remote, assetsData) ->\n  requestSite = if remote? then remote else null\n  assetsURL = wiki.site(requestSite).getDirectURL('assets')\n  if assetsURL is ''\n    $report.text \"site not currently reachable.\"\n    return\n\n  link = (file) ->\n    href = \"#{assetsURL}/#{if assets is '' then \"\" else assets + \"/\"}#{encodeURIComponent file}\"\n    # todo: no action if not logged on\n    act = unless isOwner\n      ''\n    else if remote != location.host\n      '<button class=\"copy\">⚑</button> '\n    else\n      '<button class=\"delete\">✕</button> '\n    \n    \"\"\"<span>#{act}<a href=\"#{href}\" target=_blank>#{expand file}</a></span>\"\"\"\n\n  render = (data) ->\n    assetsData[assets] ||= {}\n    if data.error\n      return $report.text \"no files\" if data.error.code == 'ENOENT'\n      return $report.text \"plugin reports: #{data.error.code}\"\n    files = data.files\n    assetsData[assets][assetsURL] = files\n\n    if files.length == 0\n      return $report.text \"no files\"\n    $report.html (link file for file in files).join \"<br>\"\n\n    $report.find('button.copy').click (e) ->\n      href = $(e.target).parent().find('a').attr('href')\n      get_file $item, item, href, (form) ->\n        post_upload $item, item, form\n\n    $report.find('button.delete').click (e) ->\n      href = $(e.target).parent().find('a').attr('href')\n      delete_file $item, item, href\n\n  trouble = (e) ->\n    $report.text \"plugin error: #{e.statusText} #{e.responseText||''}\"\n\n  $.ajax\n    url: wiki.site(requestSite).getURL('plugin/assets/list')\n    data: {assets}\n    dataType: 'json'\n    success: render\n    error: trouble\n\nemit = ($item, item) ->\n  uploader = ->\n    return '' if $item.parents('.page').hasClass 'remote'\n    \"\"\"\n      <div style=\"background-color:#ddd;\" class=\"progress-bar\" role=\"progressbar\"></div>\n      <center><button class=\"upload\">upload</button></center>\n      <input style=\"display: none;\" type=\"file\" name=\"uploads[]\" multiple=\"multiple\">\n    \"\"\"\n\n  $item.append \"\"\"\n    <div style=\"background-color:#eee;padding:15px; margin-block-start:1em; margin-block-end:1em;\">\n      <dl style=\"margin:0;color:gray\"></dl>\n      #{uploader()}\n    </div>\n  \"\"\"\n\n  assetsData = {}\n  $item.addClass 'assets-source'\n  $item.get(0).assetsData = -> assetsData\n\n  assets = item.text.match(/([\\w\\/-]*)/)[1]\n  for site in context $item\n    $report = $item.find('dl').prepend \"\"\"\n      <dt><img width=12 src=\"#{wiki.site(site).flag()}\"> #{site}</dt>\n      <dd style=\"margin:8px;\"></dd>\n    \"\"\"\n    fetch_list $item, item, $report.find('dd:first'), assets, site, assetsData\n\n\nbind = ($item, item) ->\n  assets = item.text.match(/([\\w\\/-]*)/)[1]\n\n  $item.dblclick -> wiki.textEditor $item, item\n\n  # https://coligo.io/building-ajax-file-uploader-with-node/\n  $button = $item.find '.upload'\n  $input = $item.find 'input'\n\n  $button.click (e) ->\n    $input.click()\n\n  $input.on 'change', (e) ->\n    upload $(this).get(0).files\n\n  $item.on 'dragover', ignore\n  $item.on 'dragenter', ignore\n  $item.on 'drop', (e) ->\n    ignore e\n    upload e.originalEvent.dataTransfer?.files\n\n  upload = (files) ->\n    return unless files?.length\n    form = new FormData()\n    form.append 'assets', assets\n    for file in files\n      form.append 'uploads[]', file, file.name\n    post_upload $item,item,form\n\nwindow.plugins.assets = {emit, bind} if window?\nmodule.exports = {expand} if module?\n"
  ]
}